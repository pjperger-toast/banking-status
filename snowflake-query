### Query for MOST RECENT banking info status
### NOTE -- BE CAREFUL USING task_last_updated
### A NULL value may result in the most recent task status not showing.
### (see oat-nerds post on 04/12)

select
    t.account_toast_guid as restaurantId,
    t.task_status_new as statuses,
    t.task_last_updated as last_updated,
    revision
from
    TOAST.SOURCE_TOAST_ORDERS.task_view_current t
WHERE
    t.task_name = 'provide-location-banking-info' QUALIFY RANK() OVER(
        PARTITION BY t.account_toast_guid,
        task_name
        ORDER by
            REVISION DESC
    ) = 1

### Query for MOST RECENT exit test mode status
### Similar NOTE to the query above

select
    t.account_toast_guid as restaurantId,
    t.task_status_new as statuses,
    t.task_last_updated as last_updated,
    revision
from
    TOAST.SOURCE_TOAST_ORDERS.task_view_current t
WHERE
    t.task_name = 'self-service-leave-test-mode' QUALIFY RANK() OVER(
        PARTITION BY t.account_toast_guid,
        task_name
        ORDER by
            REVISION DESC
    ) = 1

### OLD -- DONT USE
### The below query does not show the most recent status.

SELECT
    t.account_toast_guid as restaurantId
    , listagg(DISTINCT t.task_status_new, ',') WITHIN GROUP (ORDER BY t.task_status_new ) as statuses
    , min(t.task_last_updated) as last_updated
FROM
    TOAST.SOURCE_TOAST_ORDERS.task_view_current t
WHERE
    t.task_name = 'provide-location-banking-info'
GROUP BY ACCOUNT_TOAST_GUID
HAVING last_updated >= '2023-01-01'
